---
title: 'SQL advanced'
description: SQL ë‹¤ì¤‘ í…Œì´ë¸” ì¿¼ë¦¬, í´ë¼ìš°ë“œ ë°ì´í„°ë² ì´ìŠ¤ì™€ ì—°ê²°, NoSQLì— ëŒ€í•œ ì •ì˜ì™€ ì¢…ë¥˜, íŠ¸ëœì­ì…˜ê³¼ ACID, Group by ì‚¬ìš©
categories:
 - Data Engineering
tags: [Data Engineering, SQL, Cloud DB, ë‹¤ì¤‘ í…Œì´ë¸” ì¿¼ë¦¬, NoSQL, íŠ¸ëœì­ì…˜, ACID, Group by]
mathjax: enable
# 0ï¸âƒ£1ï¸âƒ£2ï¸âƒ£3ï¸âƒ£4ï¸âƒ£5ï¸âƒ£6ï¸âƒ£7ï¸âƒ£8ï¸âƒ£9ï¸âƒ£ğŸ”Ÿ
---



# íŠ¸ëœì­ì…˜
- íŠ¸ëœì­ì…˜ : í†µìƒì ìœ¼ë¡œ ì •ë³´ì˜ êµí™˜ì´ë‚˜ ë°ì´í„°ë² ì´ìŠ¤ ê°±ì‹  ë“± ì¼ë ¨ì˜ ì‘ì—…ë“¤ì— ëŒ€í•´ ì—°ì†ì²˜ë¦¬ë‹¨ìœ„ë¥¼ ì˜ë¯¸
  - DBì˜ ë¬´ê²°ì„±ì´ ë³´ì¥ë˜ëŠ” ìƒíƒœì—ì„œ ìš”ì²­ëœ ì‘ì—…ì„ ì™„ìˆ˜í•˜ê¸° ìœ„í•œ ì‘ì—…ì˜ ê¸°ë³¸ ë‹¨ìœ„ë¡œ ê°„ì£¼
  - ê°„ë‹¨íˆ **DBì˜ ìƒíƒœë¥¼ ë³€í™”ì‹œí‚¤ëŠ” ì‘ì—…ì˜ ëª¨ìŒ**
  - ì£¼ë¡œ DBì˜ ìƒíƒœë¥¼ ë³€í™”ì‹œí‚¤ëŠ” INSERT, DELETE, UPDATE ì¤‘ í•œê°œ ì´ìƒì˜ DML(Data Manipulation Language)ê³¼ ê°™ì´ ì‚¬ìš©
- ìƒí™œ ì† ì˜ˆì‹œ

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2021-09-10 12 32 39](https://user-images.githubusercontent.com/79494088/132795270-d5a3bb28-3990-417d-967e-0f453a9bb452.png)

- ìœ„ ì‘ì—… ì¤‘ ì–´ëŠ í•˜ë‚˜ê°€ ì‹¤íŒ¨ë¡œ ì‹¤í–‰ëœë‹¤ë©´ ìœ„ì˜ ì „ì œëŠ” ì‹¤í–‰ë˜ì–´ì„  ì•ˆëœë‹¤.

## COMMITê³¼ Rollback

```sql
CREATE TABLE user ( -- í…Œì´ë¸” ìƒì„±
	id varchar(10) primary Key,
	name varchar(10)
);

INSERT INTO user VALUES ('id1', 'user1'); -- ê°’ insert
INSERT INTO user VALUES ('id2', 'user2');

COMMIT; -- commitì„ í•˜ì§€ ì•Šìœ¼ë©´ ì¬ê°€ë™ ì‹œ ìœ„ì˜ ê°’ë“¤ ëª¨ë‘ reset

INSERT INTO user VALUES ('id3', 'user3');

ROLLBACK; -- commitì„ ì˜ëª»í•˜ë©´ ìˆ˜ë™ì ìœ¼ë¡œ rollback
```

- íŠ¸ëœì­ì…˜ : ì—¬ëŸ¬ ê°œì˜ ì‘ì—…ì„ í•˜ë‚˜ì˜ ì‹¤í–‰ ìœ ë‹›ìœ¼ë¡œ ë¬¶ì–´ì¦Œ ê²ƒ
- ê° íŠ¸ëœì­ì…˜ì€ í•˜ë‚˜ì˜ íŠ¹ì • ì‘ì—…ìœ¼ë¡œ ì‹œì‘í•´ ë¬¶ì—¬ ìˆëŠ” ëª¨ë“  ì‘ì—…ì„ ë‹¤ ì™„ë£Œí•´ì•¼ ëë‚˜ê²Œ ë˜ì–´ìˆë‹¤.
- ë§Œì•½ í•œ ê°œì˜ ì‘ì—…ì´ë¼ë„ ì‹¤íŒ¨í•˜ê²Œ ëœë‹¤ë©´ ì „ë¶€ ì‹¤íŒ¨í•œë‹¤.
- ì‘ì—…ì´ í•˜ë‚˜ë¼ë„ ì‹¤íŒ¨í•˜ë©´ íŠ¸ëœì­ì…˜ë„ ì‹¤íŒ¨ì´ê³  ëª¨ë“  ì‘ì—…ì´ ì„±ê³µì ì´ë©´ íŠ¸ëœì­ì…˜ ë˜í•œ ì„±ê³µì ì´ê²Œ ëœë‹¤.
- íŠ¸ëœì­ì…˜ì€ ë¯¸ì™„ë£Œëœ ë‹¨ê³„ì—†ì´ ì „ë¶€ë¥¼ ì„±ê³µí•´ì•¼ í•œë‹¤.
- ë°ì´í„°ë² ì´ìŠ¤ íŠ¸ëœì­ì…˜ì˜ ì •ì˜ëŠ” ACID íŠ¹ì„±ì„ ê°€ì§€ê³  ìˆë‹¤.

# ACID 

## Atomicity(ì›ìì„±)
- í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ì„ êµ¬ì„±í•˜ëŠ” ì‘ì—…ì€ ì „ë¶€ ì„±ê³µí•˜ê±°ë‚˜ ì „ë¶€ ì‹¤íŒ¨í•´ì•¼ ëœë‹¤.
- ë¶€ë¶„ì ìœ¼ë¡œ ì‹¤í–‰ë˜ë©´ ì•ˆëœë‹¤.
- SQLì—ì„œ íŠ¹ì • ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í–ˆëŠ”ë° ë¶€ë¶„ì ìœ¼ë¡œ ì‹¤íŒ¨í•˜ëŠ” ë¶€ë¶„ì´ ìˆë‹¤ë©´ ì „ë¶€ ì‹¤íŒ¨í•˜ê²Œ ë˜ì–´ìˆë‹¤(ì¶©ëŒ ìš”ì¸ì— ëŒ€í•´ ì„ íƒì§€ë¥¼ ì œê³µí•œë‹¤).

## Consistency(ì¼ê´€ì„±)
- í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ ì´ì „ê³¼ ì´í›„ ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœëŠ” ì´ì „ê³¼ ê°™ì´ ìœ íš¨í•´ì•¼ í•œë‹¤.
- ë°ì´í„°ë² ì´ìŠ¤ì˜ ì œì•½ì´ë‚˜ ê·œì¹™ì— ì˜ê±°í•œ ë°ì´í„°ë² ì´ìŠ¤ì—¬ì•¼ í•œë‹¤.
- cf. user í…Œì´ë¸”ì— idì™€ nameì´ ìˆì–´ì•¼ í•œë‹¤ë©´, ë‘˜ ì¤‘ í•˜ë‚˜ê°€ ì—†ë‹¤ë©´ ì§„í–‰ë˜ì§€ ì•ŠëŠ”ë‹¤.

## Isolation(ê³ ë¦½ì„±)
- í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ì´ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ê³¼ ë…ë¦½ë˜ì–´ì•¼ í•œë‹¤.
- ì‹¤ì œë¡œ ë™ì‹œì— ì—¬ëŸ¬ ê°œì˜ íŠ¸ëœì­ì…˜ì´ ìˆ˜í–‰ë  ë•Œ ê° íŠ¸ëœì­ì…˜ì€ ê³ ë¦½ë˜ì–´ ìˆì–´ ì—°ì†ìœ¼ë¡œ ì‹¤í–‰ëœ ê²ƒê³¼ ë™ì¼í•œ ê²°ê³¼ë¥¼ ë‚˜íƒ€ë‚´ì•¼ í•œë‹¤.
- ê° íŠ¸ëœì­ì…˜ì€ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì˜ ì—°ì‚° ë‚´ìš©ì„ ì•Œ ìˆ˜ ì—†ë‹¤.
- ë™ì‹œì— ì‹¤í–‰ë  ë•Œì™€ ì—°ì†ìœ¼ë¡œ ì‹¤í–‰ë  ë•Œì˜ ë°ì´í„° ë² ì´ìŠ¤ ìƒíƒœê°€ ë™ì¼í•´ì•¼ í•œë‹¤.

## Durability(ì§€ì†ì„±)
- í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜í–‰ë˜ì—ˆë‹¤ë©´ í•´ë‹¹ íŠ¸ëœì­ì…˜ì— ëŒ€í•œ ë¡œê·¸ê°€ ë‚¨ê³  ëŸ°íƒ€ì„ ì˜¤ë¥˜ë‚˜ ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ í•´ë‹¹ ê¸°ë¡ì€ ì˜êµ¬ì ì´ì–´ì•¼ í•œë‹¤.

# SQL More

## ë‚´ì¥í•¨ìˆ˜

### GROUP BY
- ë°ì´í„°ë¥¼ ì¡°íšŒí•  ë•Œ ë¶„ë¥˜í•˜ì—¬ ë¬¶ì–´ì„œ ì¡°íšŒí•˜ëŠ” ê¸°ëŠ¥

```sql
SELECT * FROM customers;
```

- ê° ì£¼ ê¸°ë°˜ ê·¸ë£¹í™”

```sql
SELECT State, COUNT(*)
FROM customers
GROUP BY State;
```

### HAVING
- GROUP BYë¡œ ì¡°íšŒëœ ê²°ê³¼ì— ëŒ€í•œ í•„í„°

```sql
SELECT State, COUNT(*)
FROM customers
GROUP BY State
HAVING COUNT(*) >= 3
```

- coustomersì˜ ìˆ˜ê°€ 3ì„ ë„˜ëŠ” ê²°ê³¼ë§Œ ì¡°íšŒ
- WHEREëŠ” ê·¸ë£¹í™”í•˜ê¸° ì „ì— ì¡°íšŒë˜ëŠ” ë ˆì½”ë“œë¥¼ í•„í„°

### GROUP BY í›„
- `COUNT()` : ëª‡ ê°œì¸ì§€ ê°’ì„ ë¦¬í„´
- `SUM()` : í•©
- `AVG()` : í‰ê· 
- `MAX()`, `MIN()` : ìµœëŒ€, ìµœì†Œê°’ 

```sql
SELECT *, COUNT(*) FROM customers
GROUP BY State;
```

## SELECT ì‹¤í–‰ ìˆœì„œ
1. FROM
2. WHERE
3. GROUP BY
4. HAVING
5. SELECT
6. ORDER BY

```sql
SELECT CustomerId, AVG(Total) -- 5. ì¡°íšŒëœ ê²°ê³¼ì—ì„œ CustomerId í•„ë“œì™€ Total í•„ë“œì˜ í‰ê· ê°’ ì¶”ì¶œ
FROM invoices -- 1. invoices í…Œì´ë¸”ì— ì ‘ê·¼
WHERE CustomerId >= 10 -- 2. CustomerId í•„ë“œê°€ 10 ì´ìƒì¸ ë ˆì½”ë“œ ì¡°íšŒ
GROUP BY CustomerId -- 3. CustomerId ê¸°ì¤€ ê·¸ë£¹í™”
HAVING SUM(Total) >= 30 -- 4. Total í•„ë“œì˜ ê°’ë“¤ì˜ í•©ì´ 30 ì´ìƒì¸ ê²°ê³¼ë“¤ë§Œ í•„í„°
ORDER BY 2 -- 6. AVG(Total) í•„ë“œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
```

## etc
- CASE : SQLì—ì„œì˜ ifë¬¸
- SUBQUERY : ì¿¼ë¦¬ë¬¸ì„ ì‘ì„±í•  ë•Œ ë‹¤ë¥¸ ì¿¼ë¦¬ë¬¸ì„ í¬í•¨í•˜ëŠ” ê²ƒ(JOINê³¼ ìœ ì‚¬)

```sql
SELECT customers.LastName ,
	   (SELECT COUNT(*) FROM invoices WHERE customers.CustomerId = invoices.CustomerId) AS InvoiceCount
FROM   customers;

-- JOIN
SELECT c.LastName , COUNT(*) AS invoceCount
FROM customers c
JOIN invoices i 
ON   c.CustomerId == i.CustomerId
GROUP BY c.CustomerId;
```

# Reference
- **ACID**
  - [Atomicity Consistency Isolation Durability (ACID)](https://www.techopedia.com/definition/23949/atomicity-consistency-isolation-durability-acid-database-management-system)
  - [Manage MySQL Transactions in Python](https://pynative.com/python-mysql-transaction-management-using-commit-rollback/)